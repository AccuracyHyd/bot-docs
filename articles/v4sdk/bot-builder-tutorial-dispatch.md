---
title: Use the Dispatch tool for LUIS and QnA Maker | Microsoft Docs
description: Learn how to use LUIS and QnA maker in your bot.
author: DeniseMak
ms.author: v-demak
manager: kamrani
ms.topic: article
ms.prod: bot-framework
ms.date: 04/25/2018
monikerRange: 'azure-bot-service-4.0'
---

## Integrate multiple LUIS apps and QnA services with the Dispatch tool

This tutorial demonstrates how to use a LUIS model generated by the Dispatch tool, to integrate your bot with multiple Language Understanding (LUIS) apps and QnAMaker services. 

Imagine you've developed the following services, and you want to create a bot that integrates with all of them.

| Service type | Name | Description |
|------|------|------|
| LUIS app | HomeAutomation | Recognizes the HomeAutomation.TurnOn, HomeAutomation.TurnOff, and HomeAutomation.None intents.|
| LUIS app | Weather | Recognizes the Weather.GetForecast and Weather.GetCondition intents.|
| QnAMaker service | SmartLightFAQ  | Provides answers to questions about a home automation lighting system |

Let's first create the apps and services, then integrate them together.

## Create the LUIS apps

The fastest way to create the HomeAutomation and Weather LUIS apps is to download the [homeautomation.json][HomeAutomationJSON] and [weather.json][WeatherJSON] files. Then go to the [LUIS website](https://www.luis.ai/home) and sign in. Click on **My Apps** > **Import new app** and choose the homeautomation.json file. Name the new app `homeautomation`. Click on **My Apps** > **Import new app** and choose the weather.json file. Name this other new app `weather`.

## Create the QnA Maker service

Go to the [QnA Maker website](https://qnamaker.ai) and sign in. Select **Create new service** and create a new service named "SmartLightFAQ". Click the **Select file** button and upload the [sample TSV file][FAQ_TSV]. Click **Create**, and once the service is created, click **Publish**.

## Use the Dispatch tool to create the dispatcher LUIS app

Next, let's create a LUIS app to combine each of the services we created.

Install the [Dispatch tool][DispatchTool] by running this command at a Node.js command prompt.

```
npm install -g botdispatch
```

Run the following command to initialize the Dispatch tool of the name `CombineWeatherAndLights`. Substitute your [LUIS authoring key](https://docs.microsoft.com/en-us/azure/cognitive-services/LUIS/luis-concept-keys) for `"YOUR-LUIS-AUTHORING-KEY"`.

```
dispatch init -name CombineWeatherAndLights -luisAuthoringKey "YOUR-LUIS-AUTHORING-KEY" -luisAuthoringRegion westus
```

For each of the LUIS apps that you created, get the LUIS app ID. Those can be found for each app under **My Apps** on the [LUIS site](https://www.luis.ai/home); click on the app name, and then click on **Settings** to see the Application ID. 

Then run the `dispatch add` command for each of the LUIS apps and the QnA Maker service you created:

```
dispatch add -type luis -id "HOMEAUTOMATION-APP-ID" -name homeautomation -version 0.1 -key "YOUR-LUIS-AUTHORING-KEY"
dispatch add -type luis -id "WEATHER-APP-ID" -name weather -version 0.1 -key "YOUR-LUIS-AUTHORING-KEY"
dispatch add -type qna -id "QNA-KB-ID" -name smartlightfaq -key "YOUR-QNA-SUBSCRIPTION-KEY"
```

Run `dispatch create`:

```
dispatch create
```

This creates the dispatcher LUIS app named **CombineWeatherAndLights**. You can see the new app in [https://www.luis.ai/home](https://www.luis.ai/home). 

![The dispatcher app in LUIS.ai](media/tutorial-dispatch/dispatch-app-in-luis.png)

Click on the new app. Under **Intents** you can see it has the `l_homeautomation`, `l_weather`, and `q_smartlightfaq` intents.

![The dispatcher intents in LUIS.ai](media/tutorial-dispatch/dispatch-intents-in-luis.png)

Click on **Settings** to copy the ID of the new app to use in your bot.

## Create a bot using the LUIS model

Now you can hook up the dispatcher app's intents to logic in your bot, which routes messages to the original LUIS apps and QnAMaker service. Keep in mind, the intent names used in the bot must match the intents in the dispatcher app.

### Create the bot

First, make sure you have the packages necessary for LUIS and QnA Maker.

# [C#](#tab/csaddref)

[Add a reference](https://docs.microsoft.com/en-us/nuget/tools/package-manager-ui) to v4 prerelease version of the following NuGet packages:

* `Microsoft.Bot.Builder.Integration.AspNet.Core`
* `Microsoft.Bot.Builder.Ai.QnA` (required for QnA Maker)
* `Microsoft.Bot.Builder.Ai.Luis` (required for LUIS)

# [JavaScript](#tab/jsaddref)

Either of these services can be added to your bot using the botbuilder-ai package. You can add this package to your project via npm:

* `npm install --save botbuilder@preview`
* `npm install --save botbuilder-ai@preview`

---


## Create the bot

Set up the bot code to use the dispatcher app.

# [C#](#tab/csbotconfig)

Start with the code in the [LUIS Dispatch sample][DispatchBotCS]. 


In `Startup.cs`, edit the code to use the app ID of the LUIS app you just generated and your LUIS subscription key.

```csharp
public void ConfigureServices(IServiceCollection services)
{
    services.AddBot<LuisDispatchBot>(options =>
    {
        options.CredentialProvider = new ConfigurationCredentialProvider(Configuration);

        string luisModelId = "<Your LUIS app ID from Dispatch here>";
        string luisSubscriptionKey = "<Your LUIS Subscription Key here>";
        Uri luisUri = new Uri("https://westus.api.cognitive.microsoft.com/luis/v2.0/apps/");

        var luisModel = new LuisModel(luisModelId, luisSubscriptionKey, luisUri);

        // If you want to get all intents scorings, add verbose in luisOptions
        var luisOptions = new LuisRequest { Verbose = true };

        var middleware = options.Middleware;
        middleware.Add(new LuisRecognizerMiddleware(luisModel, luisOptions: luisOptions));
    });
}
```

<!--
#### Handle the intents from the dispatcher app
-->

In the following code in LuisDispatchBot.cs, if your dispatcher app detects the `l_homeautomation` or `l_weather` intent, it creates a `LuisRecognizer` to call the original `homeautomation` and `weather` apps. If the bot detects the `q_smartlightfaq` intent, or the `none` intent that is used as a fallback case, it queries QnAMaker.

```csharp
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.Bot.Builder;
using Microsoft.Bot.Builder.Ai.LUIS;
using Microsoft.Bot.Builder.Ai.QnA;
using Microsoft.Bot.Builder.Core.Extensions;
using Microsoft.Bot.Schema;


namespace Microsoft.Bot.Samples.Ai.Luis.Dispatch
{
    public class LuisDispatchBot : IBot
    {
        public LuisDispatchBot() { }
        private static QnAMakerOptions qnaOptions = new QnAMakerOptions
        {
            // add subscription key for QnA and knowledge base ID
            SubscriptionKey = "<YOUR-QNAMAKER-SUBSCRIPTION-KEY>",
            KnowledgeBaseId = "<QNAMAKER-KB-ID>"
        };

        // App ID for a LUIS model named "homeautomation"
        private static LuisModel luisModel1 =
            new LuisModel("<YOUR-LUIS-APP-ID>", "<YOUR-LUIS-SUBSCRIPTION-KEY>", new System.Uri("https://westus.api.cognitive.microsoft.com/luis/v2.0/apps/"));

        // App ID for a LUIS model named "weather"
        private static LuisModel luisModel2 =
            new LuisModel("YOUR-LUIS-APP-ID", "<YOUR-LUIS-SUBSCRIPTION-KEY>", new System.Uri("https://westus.api.cognitive.microsoft.com/luis/v2.0/apps/"));

        public async Task OnTurn(ITurnContext context)
        {
            if (context.Activity.Type is ActivityTypes.Message)
            {
                var message = context.Activity.AsMessageActivity();
                // Get the intent recognition result from the context object.
                var dispatchResult = context.Services.Get<RecognizerResult>(LuisRecognizerMiddleware.LuisRecognizerResultKey) as RecognizerResult;
                var topIntent = dispatchResult?.GetTopScoringIntent();
                LuisRecognizer luisRecognizer1, luisRecognizer2;
                RecognizerResult recognizerResult;

                var intentsList = new List<string>();
                var entitiesList = new List<string>();

                if (topIntent == null)
                {
                    await context.SendActivity("Unable to get the top intent.");
                }
                else 
                {
                    if (topIntent.Value.score < 0.3)
                    {
                        await context.SendActivity("I'm not very sure what you want but will try to send your request.");
                    }
                    switch (topIntent.Value.intent.ToLowerInvariant())
                    {
                        case "l_homeautomation":
                            await context.SendActivity("Sending your request to the home automation system ...");

                            luisRecognizer1 = new LuisRecognizer(luisModel1);
                            recognizerResult = await luisRecognizer1.Recognize(message.Text, System.Threading.CancellationToken.None);                            
                            
                            // list the intents
                            foreach (var intent in recognizerResult.Intents)
                            {
                                intentsList.Add($"'{intent.Key}', score {intent.Value}");
                            }
                            await context.SendActivity($"Intents detected by the home automation app:\n\n{string.Join("\n\n", intentsList)}");

                            // list the entities
                            entitiesList = new List<string>();
                            foreach (var entity in recognizerResult.Entities)
                            {
                                if (!entity.Key.ToString().Equals("$instance"))
                                {
                                    entitiesList.Add($"{entity.Key}: {entity.Value.First}");
                                }
                            }

                            if (entitiesList.Count > 0)
                            {
                                await context.SendActivity($"The following entities were found in the message:\n\n{string.Join("\n\n", entitiesList)}");
                            }

                            // Here, you can add code for calling the hypothetical home automation service, passing in any entity information that you need

                            break;
                        case "l_weather":
                            await context.SendActivity("Sending your request to the weather system ...");
                            luisRecognizer2 = new LuisRecognizer(luisModel2);
                            recognizerResult = await luisRecognizer2.Recognize(message.Text, System.Threading.CancellationToken.None);

                            // list the intents
                            var intentsResult2 = new List<string>();
                            foreach (var intent in recognizerResult.Intents)
                            {
                                intentsResult2.Add($"'{intent.Key}', score {intent.Value}");
                            }
                            await context.SendActivity($"Intents detected by the weather app: \n\n{string.Join("\n\n", intentsResult2)}");

                            // list the entities
                            entitiesList = new List<string>();
                            foreach (var entity in recognizerResult.Entities)
                            {
                                if (!entity.Key.ToString().Equals("$instance"))
                                {
                                    entitiesList.Add($"{entity.Key}: {entity.Value.First}");
                                }
                            }

                            if (entitiesList.Count > 0)
                            {
                                await context.SendActivity($"The following entities were found in the message:\n\n{string.Join("\n\n", entitiesList)}");
                            }

                            // Here, you can add code for calling the hypothetical weather service, passing in any entity information that you need

                            break;
                        case "none":
                        // You can provide logic here to handle the known None intent (none of the above).
                        // In this example we fall through to the QnA intent.
                        case "q_smartlightfaq":
                            QnAMaker qnaMaker = new QnAMaker(qnaOptions);
                            var messageActivity = context.Activity.AsMessageActivity();
                            if (!string.IsNullOrEmpty(messageActivity.Text))
                            {
                                var results = await qnaMaker.GetAnswers(messageActivity.Text.Trim()).ConfigureAwait(false);
                                if (results.Any())
                                {
                                    await context.SendActivity(results.First().Answer);
                                }
                                else
                                {
                                    await context.SendActivity("Couldn't find an answer in the FAQ.");
                                }
                            }
                            break;
                        default:
                            // The intent didn't match any case, so just display the recognition results.
                            await context.SendActivity($"Dispatch intent: {topIntent.Value.intent} ({topIntent.Value.score}).");

                            break;
                    }
                }                

            }
            else if (context.Activity.Type is ActivityTypes.ConversationUpdate)
            {
                foreach (var newMember in context.Activity.MembersAdded)
                {
                    if (newMember.Id != context.Activity.Recipient.Id)
                    {
                        await context.SendActivity("Hello and welcome to the LUIS Dispatch sample bot. This bot dispatches messages to LUIS apps and QnA, using a LUIS model generated by the Dispatch tool.");
                    }
                }
            }
        }
    }
}
```

# [JavaScript](#tab/jsbotconfig)

Start with the code in the [Dispatch bot sample][DispatchBotJs]. Open `app.js` and optionally replace the `appId` fields with the IDs of the LUIS apps you created. If you leave the `appId` fields as they originally are, you'll be using public LUIS apps created for demonstration purposes.

```javascript
// Create LuisRecognizers and QnAMaker
// The LUIS applications are public, meaning you can use your own subscription key to test the applications.
// For QnAMaker, users are required to create their own knowledge base.
// The exported LUIS applications and QnAMaker knowledge base can be found adjacent to this sample bot.

// The corresponding LUIS application JSON is `dispatchSample.json`
const dispatcher = new LuisRecognizer({
    appId: '0b18ab4f-5c3d-4724-8b0b-191015b48ea9',
    subscriptionKey: process.env.LUIS_SUBSCRIPTION_KEY,
    serviceEndpoint: 'https://westus.api.cognitive.microsoft.com/',
    verbose: true
});

// The corresponding LUIS application JSON is `homeautomation.json`
const homeAutomation = new LuisRecognizer({
    appId: 'c6d161a5-e3e5-4982-8726-3ecec9b4ed8d',
    subscriptionKey: process.env.LUIS_SUBSCRIPTION_KEY,
    serviceEndpoint: 'https://westus.api.cognitive.microsoft.com/',
    verbose: true
});

// The corresponding LUIS application JSON is `weather.json`
const weather = new LuisRecognizer({
    appId: '9d0c9e9d-ce04-4257-a08a-a612955f2fb5',
    subscriptionKey: process.env.LUIS_SUBSCRIPTION_KEY,
    serviceEndpoint: 'https://westus.api.cognitive.microsoft.com/',
    verbose: true
});
```

In the following code, replace the `subscriptionKey` and `knowledgeBaseID` with your key and knowledge base ID from QnAMaker:

```javascript
// The QnAMaker knowledge base used in this sample is `sampleKnowledgeBase.tsv`
const faq = new QnAMaker({
    knowledgeBaseId: 'YOUR-QNA-KB-ID',
    subscriptionKey: process.env.QNA_SUBSCRIPTION_KEY,
    serviceEndpoint: 'https://westus.api.cognitive.microsoft.com/'
});

```

The rest of the code in `app.js` handles the `l_homeautomation`, `l_weather`, and `None` intents by launching appropriate dialogs. In the case of the `q_smartlightfaq` intent, it replies with the answer from the QnAMaker service.


```javascript
// create conversation state
const conversationState = new ConversationState(new MemoryStorage());
adapter.use(conversationState);

// register some dialogs for usage with the LUIS apps that are being dispatched to
const dialogs = new DialogSet();

function findEntities(entityName, entityResults) {
    let entities = []
    if (entityName in entityResults) {
        entityResults[entityName].forEach((entity, idx) => {
            entities.push(entity);
        });
    }
    return entities.length > 0 ? entities : undefined;
}

dialogs.add('HomeAutomation_TurnOff', [
    async (dialogContext, args) => {
        const devices = findEntities('HomeAutomation_Device', args.entities);
        const operations = findEntities('HomeAutomation_Operation', args.entities);

        const state = conversationState.get(dialogContext.context);
        state.homeAutomationTurnOff = state.homeAutomationTurnOff ? state.homeAutomationTurnOff + 1 : 1;
        await dialogContext.context.sendActivity(`${state.homeAutomationTurnOff}: You reached the "HomeAutomation.TurnOff" dialog.`);
        if (devices) {
            await dialogContext.context.sendActivity(`Found these "HomeAutomation_Device" entities:\n${devices.join(', ')}`);
        }
        if (operations) {
            await dialogContext.context.sendActivity(`Found these "HomeAutomation_Operation" entities:\n${operations.join(', ')}`);
        }
        await dialogContext.end();
    }
]);

dialogs.add('HomeAutomation_TurnOn', [
    async (dialogContext, args) => {
        const devices = findEntities('HomeAutomation_Device', args.entities);
        const operations = findEntities('HomeAutomation_Operation', args.entities);

        const state = conversationState.get(dialogContext.context);
        state.homeAutomationTurnOn = state.homeAutomationTurnOn ? state.homeAutomationTurnOn + 1 : 1;
        await dialogContext.context.sendActivity(`${state.homeAutomationTurnOn}: You reached the "HomeAutomation.TurnOn" dialog.`);
        if (devices) {
            await dialogContext.context.sendActivity(`Found these "HomeAutomation_Device" entities:\n${devices.join(', ')}`);
        }
        if (operations) {
            await dialogContext.context.sendActivity(`Found these "HomeAutomation_Operation" entities:\n${operations.join(', ')}`);
        }
        await dialogContext.end();
    }
]);

dialogs.add('Weather_GetForecast', [
    async (dialogContext, args) => {
        const locations = findEntities('Weather_Location', args.entities);

        const state = conversationState.get(dialogContext.context);
        state.weatherGetForecast = state.weatherGetForecast ? state.weatherGetForecast + 1 : 1;
        await dialogContext.context.sendActivity(`${state.weatherGetForecast}: You reached the "Weather.GetForecast" dialog.`);
        if (locations) {
            await dialogContext.context.sendActivity(`Found these "Weather_Location" entities:\n${locations.join(', ')}`);
        }
        await dialogContext.end();
    }
]);

dialogs.add('Weather_GetCondition', [
    async (dialogContext, args) => {
        const locations = findEntities('Weather_Location', args.entities);

        const state = conversationState.get(dialogContext.context);
        state.weatherGetCondition = state.weatherGetCondition ? state.weatherGetCondition + 1 : 1;
        await dialogContext.context.sendActivity(`${state.weatherGetCondition}: You reached the "Weather.GetCondition" dialog.`);
        if (locations) {
            await dialogContext.context.sendActivity(`Found these "Weather_Location" entities:\n${locations.join(', ')}`);
        }
        await dialogContext.end();
    }
]);

dialogs.add('None', [
    async (dialogContext) => {
        const state = conversationState.get(dialogContext.context);
        state.noneIntent = state.noneIntent ? state.noneIntent + 1 : 1;
        await dialogContext.context.sendActivity(`${state.noneIntent}: You reached the "None" dialog.`);
        await dialogContext.end();
    }
]);

adapter.use(dispatcher);

// Listen for incoming Activities
server.post('/api/messages', (req, res) => {
    adapter.processActivity(req, res, async (context) => {
        if (context.activity.type === 'message') {
            const state = conversationState.get(context);
            const dc = dialogs.createContext(context, state);

            // Retrieve the LUIS results from our dispatcher LUIS application
            const luisResults = dispatcher.get(context);

            // Extract the top intent from LUIS and use it to select which LUIS application to dispatch to
            const topIntent = LuisRecognizer.topIntent(luisResults);

            const isMessage = context.activity.type === 'message';
            if (isMessage) {
                switch (topIntent) {
                    case 'l_homeautomation':
                        const homeAutoResults = await homeAutomation.recognize(context);
                        const topHomeAutoIntent = LuisRecognizer.topIntent(homeAutoResults);
                        await dc.begin(topHomeAutoIntent, homeAutoResults);
                        break;
                    case 'l_weather':
                        const weatherResults = await weather.recognize(context);
                        const topWeatherIntent = LuisRecognizer.topIntent(weatherResults);
                        await dc.begin(topWeatherIntent, weatherResults);
                        break;
                    case 'q_smartlightfaq':
                        await faq.answer(context);
                        break;
                    default:
                        await dc.begin('None');
                }
            }

            if (!context.responded) {
                await dc.continue();
                if (!context.responded && isMessage) {
                    await dc.context.sendActivity(`Hi! I'm the LUIS dispatch bot. Say something and LUIS will decide how the message should be routed.`);
                }
            }
        }
    });
});

```

---

## Evaluate the dispatcher's performance

Sometimes there are user messages that are provided as examples in both the LUIS apps and the QnA maker services, and the combined LUIS app that Dispatch generates won't perform well for those inputs. Check your app's performance using the `eval` option. 

```
dispatch eval
```

Running `dispatch eval` generates a **Summary.html** file that provides statistics on the performance of the new language model.

> [!TIP] 
> You can actually run `dispatch eval` on any LUIS app, not just LUIS apps created by the dispatch tool.

### Edit intents for duplicates and overlaps

Review example utterances that are flagged as duplicates in **Summary.html**, and remove similar or overlapping examples. For example, let's say that in the `homeautomation` LUIS app for homeautomation, requests like "turn my lights on" map to a "TurnOnLights" intent, but requests like "Why won't my lights turn on?" map to a "None" intent so that they can be passed on to QnA maker. When you combine the LUIS app and the QnA maker service using dispatch, you need to do one of the following: 

* Remove the "None" intent from the original `homeautomation` LUIS app, and add the utterances in that intent to the "None" intent in the dispatcher app.
* If you don't remove the "None" intent from the original LUIS app, you need to add logic in your bot to pass those messages that match that intent on to the QnA maker service.

> [!TIP] 
> Review [Best practices for Language Understanding](./bot-builder-concept-luis.md#best-practices-for-language-understanding) for tips on improving your language model's performance.

## Additional resources

* [Using LUIS for conversation flow][luis-v4-how-to]

[luis-v4-how-to]: bot-builder-howto-v4-luis.md
<!-- links -->

[HomeAutomationJSON]: https://aka.ms/dispatch-luis1
[WeatherJSON]: https://aka.ms/dispatch-luis2
[DispatchJSON]: https://aka.ms/dispatch-luis
[FAQ_TSV]: https://aka.ms/dispatch-qna-tsv

[DispatchTool]: https://github.com/Microsoft/botbuilder-tools/tree/master/Dispatch
[DispatchBotCS]: https://aka.ms/dispatch-sample-cs
[DispatchBotJs]: https://aka.ms/dispatch-sample-js



